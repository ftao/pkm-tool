<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
body {
  min-width:357px;
  overflow-x:hidden;
}

img {
  margin:5px;
  border:2px solid black;
  vertical-align:middle;
  width:75px;
  height:75px;
}
h1 {
  font-size:16px;
}
form div[data-role='fieldcontain'] {
  width:80%; 
  margin:5px 0;
}
form div[data-role='fieldcontain'] label {
  display:block;
  width:100%;
}
form div[data-role='fieldcontain'] input[type='text'] {
  width:100%;
}
form div[data-role='fieldcontain'] textarea {
  width:100%;
}
</style>
<body>
    <div id="pop_msg" class="align_center colo_aaa valign_center" style="display:none">
        <div>知识已成功保存。</div>
        <h2><a target="_blank">#</a></h2>
    </div>
    <div id="pop_form" class="submit_form align_center">
        <h1>刚刚解决了一个问题？记录一下吧。</h1>
        <form id="pkm_submit_form" action="#" method="POST">
            <div data-role="fieldcontain">
                <label for="question">问题:</label>
                <textarea name="question" id="question" rows="5" cols="40"></textarea>
            </div>
            <div data-role="fieldcontain">
                <label for="answer_page_title">这个页面解决了我的问题:</label>
                <a href="#" target="_blank" id="answer_page_a">#</a>
                <input type="hidden" name="answer_page_link" id="answer_page_link"/>
                <input type="hidden" name="answer_page_title" id="answer_page_title"/>
            </div>
            <div data-role="fieldcontain">
                <label>答案(可选):</label>
                <textarea name="answer_summary" id="answer_summary" rows="5" cols="40"></textarea>
            </div>
            <div data-role="fieldcontain">
                <label>标签:</label>
                <input type="text" name="tags" id="tags" size="20"/>
            </div>
            <div data-role="fieldcontain" class="align_right">
                <input type="hidden" id="api_token"  name="api_token"/>
                <input type="submit" id="submit" value="保存">
            </div>
        </form>
    </div>
    <div id="result_con"></div>
    <script type="text/javascript" src="jquery-1.5.2.min.js"></script>
    <script type="text/javascript" src="jquery.form.js"></script>
    <script>
      var bg = chrome.extension.getBackgroundPage();
      var query_words = bg.last_query_words;
      if (query_words.length > 0){
        document.getElementById('question').value = query_words[query_words.length -1];
      }
      var spa = $('#answer_page_a');
      var spl = $('#answer_page_link');
      var spt = $('#answer_page_title');
      chrome.tabs.getSelected(null, function(tab){
        spa.attr('href', tab.url);
        spa.text(tab.title);
        spl.val(tab.url);
        spt.val(tab.title);
      });
      $('#api_token').val('123456');
      var api_root = 'http://192.168.254.13:9000';
      // prepare Options Object 
      var options = { 
          //target:     '#result_con', 
          url:        api_root + '/api/v1/knowledge/', 
          dataType : 'json',
          error : function(data){
            //
          },
          success: function(data) { 
              $('#pop_form').hide();
              $('#pop_msg').find('h2 a').attr('href', data['permlink']).text(data['question']);
              $('#pop_msg').show();
          } 
      }; 
      // pass options to ajaxForm 
      $('#pkm_submit_form').ajaxForm(options);
      $('#question')[0].focus();
    </script>
</body>
